<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch nh√† cung c·∫•p</title>
    <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
<div class="container mt-5">
    <h1 class="text-center mb-4">Danh s√°ch nh√† cung c·∫•p</h1>
    
    <!-- Form th√™m nh√† cung c·∫•p -->
    <div class="mb-4">
        <h3>Th√™m nh√† cung c·∫•p m·ªõi</h3>
        <form id="addSupplierForm">
            <input type="text" id="fullName" placeholder="T√™n ƒë·∫ßy ƒë·ªß" required class="form-control mb-2">
            <input type="text" id="phoneNumber" placeholder="S·ªë ƒëi·ªán tho·∫°i" required class="form-control mb-2">
            <input type="email" id="email" placeholder="Email" required class="form-control mb-2">
            <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ" required class="form-control mb-2">
            <select id="status" class="form-control mb-2">
                <option value="active">Ho·∫°t ƒë·ªông</option>
                <option value="inactive">Ng·ª´ng ho·∫°t ƒë·ªông</option>
            </select>
            <button type="submit" class="btn btn-primary">Th√™m nh√† cung c·∫•p</button>
        </form>
    </div>
    
    <!-- Danh s√°ch nh√† cung c·∫•p -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>T√™n ƒë·∫ßy ƒë·ªß</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>Email</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="supplierTableBody">
            <% suppliers.forEach(supplier => { %>
                <tr id="row-<%= supplier._id %>">
                    <td><%= supplier._id %></td>
                    <td><%= supplier.fullName %></td>
                    <td><%= supplier.phoneNumber %></td>
                    <td><%= supplier.email %></td>
                    <td><%= supplier.address %></td>
                    <td><%= supplier.status %></td>
                    <td>
                        <!-- <button class="btn btn-warning btn-sm" onclick="editSupplier('<%= supplier._id %>')">S·ª≠a</button> -->
                        <button class="btn btn-warning btn-sm" onclick="editSupplier('<%= supplier._id %>')">S·ª≠a</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSupplier('<%= supplier._id %>')">X√≥a</button>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<!-- Modal ch·ªânh s·ª≠a nh√† cung c·∫•p -->
<div class="modal fade" id="editSupplierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªânh s·ª≠a nh√† cung c·∫•p</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editSupplierId">
                <input type="text" id="editFullName" class="form-control mb-2" placeholder="T√™n ƒë·∫ßy ƒë·ªß">
                <input type="text" id="editPhoneNumber" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                <input type="email" id="editEmail" class="form-control mb-2" placeholder="Email">
                <input type="text" id="editAddress" class="form-control mb-2" placeholder="ƒê·ªãa ch·ªâ">
                <select id="editStatus" class="form-control mb-2">
                    <option value="active">Ho·∫°t ƒë·ªông</option>
                    <option value="inactive">Ng·ª´ng ho·∫°t ƒë·ªông</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="updateSupplier()">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<script>
    
   $(document).ready(() => {
    $('#addSupplierForm').submit(function(event) {
        event.preventDefault();
        
        const data = {
            fullName: $('#fullName').val(),
            phoneNumber: $('#phoneNumber').val(),
            email: $('#email').val(),
            address: $('#address').val(),
            status: $('#status').val()
        };

        console.log("üì§ G·ª≠i request th√™m nh√† cung c·∫•p:", data); // Log tr∆∞·ªõc khi g·ª≠i

        $.post('/suppliers/create', data, function(response) {
            console.log("‚úÖ Th√™m th√†nh c√¥ng! D·ªØ li·ªáu:", response); // Log khi th√™m th√†nh c√¥ng
            alert("Th√™m th√†nh c√¥ng!");
            location.reload();
        }).fail(function(xhr) {
            console.error("‚ùå L·ªói khi th√™m:", xhr.responseText);
            alert("L·ªói khi th√™m nh√† cung c·∫•p: " + xhr.responseText);
        });
    });
});
// H√†m g·ªçi API c·∫≠p nh·∫≠t nh√† cung c·∫•p
function updateSupplier() {
    const id = document.getElementById("editSupplierId").value.trim();

    if (!id) {
        alert("L·ªói: Kh√¥ng t√¨m th·∫•y ID nh√† cung c·∫•p!");
        return;
    }

    const data = {
        fullName: document.getElementById("editFullName").value.trim(),
        phoneNumber: document.getElementById("editPhoneNumber").value.trim(),
        email: document.getElementById("editEmail").value.trim(),
        address: document.getElementById("editAddress").value.trim(),
        status: document.getElementById("editStatus").value
    };

    console.log("üì° G·ª≠i request c·∫≠p nh·∫≠t:", JSON.stringify(data));

    $.ajax({
        url: `/suppliers/update/${id}`,
        type: "PUT",
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function (response) {
            alert(response.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng!");
            location.reload();
        },
        error: function (xhr) {
            console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t:", xhr.responseText);
            alert("L·ªói khi c·∫≠p nh·∫≠t: " + (xhr.responseJSON?.message || "Kh√¥ng x√°c ƒë·ªãnh"));
        }
    });
}


// S·ª≠ d·ª•ng trong form submit
$('#editSupplierForm').submit(function(event) {
    event.preventDefault();
    
    const supplierId = $('#editSupplierId').val();
    const supplierData = {
        name: $('#editSupplierName').val().trim(),
        phone: $('#editSupplierPhone').val().trim(),
        address: $('#editSupplierAddress').val().trim(),
        email: $('#editSupplierEmail').val().trim()
        // Th√™m c√°c tr∆∞·ªùng kh√°c n·∫øu c·∫ßn
    };
    
    updateSupplier(supplierId, supplierData);
});
function editSupplier(id) {
    
    // T√¨m ph·∫ßn t·ª≠ ch·ª©a d·ªØ li·ªáu trong b·∫£ng
    const row = document.getElementById(`row-${id}`);
    if (!row) {
        alert("Kh√¥ng t√¨m th·∫•y nh√† cung c·∫•p!");
        return;
    }

    // L·∫•y d·ªØ li·ªáu t·ª´ h√†ng t∆∞∆°ng ·ª©ng
    const fullName = row.children[1].textContent;
    const phoneNumber = row.children[2].textContent;
    const email = row.children[3].textContent;
    const address = row.children[4].textContent;
    const status = row.children[5].textContent;

    // ƒêi·ªÅn d·ªØ li·ªáu v√†o modal ch·ªânh s·ª≠a
    document.getElementById("editSupplierId").value = id;
    document.getElementById("editFullName").value = fullName;
    document.getElementById("editPhoneNumber").value = phoneNumber;
    document.getElementById("editEmail").value = email;
    document.getElementById("editAddress").value = address;
    document.getElementById("editStatus").value = status;

    // Hi·ªÉn th·ªã modal Bootstrap
    const editModal = new bootstrap.Modal(document.getElementById("editSupplierModal"));
    editModal.show();
}


async function deleteSupplier(id) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√† cung c·∫•p n√†y kh√¥ng?")) return;

    try {
        const response = await fetch(`http://localhost:3000/suppliers/delete/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" }
        });

        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.message || "X√≥a th·∫•t b·∫°i!");
        }

        alert("X√≥a th√†nh c√¥ng!");
        document.getElementById(`row-${id}`).remove(); // X√≥a h√†ng kh·ªèi b·∫£ng m√† kh√¥ng c·∫ßn reload
    } catch (error) {
        console.error("L·ªói khi x√≥a:", error);
        alert(`L·ªói khi x√≥a: ${error.message}`);
    }
}

</script>
</body>
</html>
