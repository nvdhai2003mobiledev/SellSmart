<%- include('../layouts/main.ejs') %>
<div class="main-content">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-0"><%= title %></h1>
        </div>
        <div class="col-md-4 text-end">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                <i class="fas fa-plus me-2"></i>Thêm nhân viên mới
            </button>
        </div>
    </div>

    <!-- Filter options -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="departmentFilter" class="form-label">Phòng ban</label>
                    <select class="form-select" id="departmentFilter">
                        <option value="">Tất cả phòng ban</option>
                        <option value="Kỹ thuật">Kỹ thuật</option>
                        <option value="Nhân sự">Nhân sự</option>
                        <option value="Kế toán">Kế toán</option>
                        <option value="Kinh doanh">Kinh doanh</option>
                        <option value="Marketing">Marketing</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Trạng thái</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">Tất cả trạng thái</option>
                        <option value="active">Đang làm việc</option>
                        <option value="inactive">Đã nghỉ việc</option>
                        <option value="leave">Nghỉ phép</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="searchInput" class="form-label">Tìm kiếm</label>
                    <input type="text" class="form-control" id="searchInput"
                           placeholder="Tìm theo tên, mã nhân viên, email...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-primary w-100" id="applyFilter">
                        <i class="fas fa-filter me-2"></i>Lọc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employee List -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th scope="col">Mã NV</th>
                        <th scope="col">Thông tin</th>
                        <th scope="col">Phòng ban</th>
                        <th scope="col">Chức vụ</th>
                        <th scope="col">Lương</th>
                        <th scope="col">Ngày vào làm</th>
                        <th scope="col">Trạng thái</th>
                        <th scope="col" class="text-end">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <% if (employees && employees.length > 0) { %>
                        <% employees.forEach(employee => { %>
                            <tr>
                                <td><span class="fw-medium"><%= employee.employeeId %></span></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <% if (employee.userId && employee.userId.avatar) { %>
                                            <img src="<%= employee.userId.avatar %>" alt="Avatar"
                                                 class="avatar-sm me-3">
                                        <% } else { %>
                                            <div class="avatar-sm me-3 bg-light d-flex align-items-center justify-content-center rounded-circle">
                                                <i class="fas fa-user text-secondary"></i>
                                            </div>
                                        <% } %>
                                        <div>
                                            <h6 class="mb-0"><%= employee.userId ? employee.userId.fullName : '' %></h6>
                                            <small class="text-muted">
                                                <i class="fas fa-envelope me-1"></i><%= employee.userId ? employee.userId.email : '' %>
                                            </small><br>
                                            <small class="text-muted">
                                                <i class="fas fa-phone me-1"></i><%= employee.userId ? employee.userId.phoneNumber : '' %>
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td><%= employee.department %></td>
                                <td><%= employee.position %></td>
                                <td><%= employee.salary.toLocaleString() %> VNĐ</td>
                                <td><%= new Date(employee.hireDate).toLocaleDateString('vi-VN') %></td>
                                <td>
                                    <% if (employee.workStatus === 'active') { %>
                                        <span class="badge bg-success">Đang làm việc</span>
                                    <% } else if (employee.workStatus === 'inactive') { %>
                                        <span class="badge bg-danger">Đã nghỉ việc</span>
                                    <% } else if (employee.workStatus === 'leave') { %>
                                        <span class="badge bg-warning text-dark">Nghỉ phép</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary"><%= employee.workStatus %></span>
                                    <% } %>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-info view-btn" data-id="<%= employee.employeeId %>">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-primary edit-btn"
                                            data-id="<%= employee.employeeId %>">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-btn"
                                            data-id="<%= employee.employeeId %>">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Chưa có dữ liệu nhân viên
                                </div>
                            </td>
                        </tr>
                    <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEmployeeModalLabel">Thêm nhân viên mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEmployeeForm">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin cơ bản</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="employeeId" class="form-label">Mã nhân viên <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="employeeId" name="employeeId" required>
                        </div>
                        <div class="col-md-6">
                            <label for="fullName" class="form-label">Họ và tên <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fullName" name="fullName" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label for="phoneNumber" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="gender" class="form-label">Giới tính</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="male">Nam</option>
                                <option value="female">Nữ</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="dob" class="form-label">Ngày sinh</label>
                            <input type="date" class="form-control" id="dob" name="dob">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="address" class="form-label">Địa chỉ</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>
                    </div>
                    <!-- Thêm trường avatar -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Avatar</label>
                            <select class="form-select" id="avatarType" name="avatarType">
                                <option value="url">Nhập URL</option>
                                <option value="file">Upload file</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div id="avatarUrlInput" class="avatar-option">
                                <label for="avatarUrl" class="form-label">URL Avatar</label>
                                <input type="url" class="form-control" id="avatarUrl" name="avatarUrl">
                            </div>
                            <div id="avatarFileInput" class="avatar-option" style="display: none;">
                                <label for="avatarFile" class="form-label">Upload File</label>
                                <input type="file" class="form-control" id="avatarFile" name="avatarFile"
                                       accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin công việc</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="department" class="form-label">Phòng ban <span
                                        class="text-danger">*</span></label>
                            <select class="form-select" id="department" name="department" required>
                                <option value="">Chọn phòng ban</option>
                                <option value="Kỹ thuật">Kỹ thuật</option>
                                <option value="Nhân sự">Nhân sự</option>
                                <option value="Kế toán">Kế toán</option>
                                <option value="Kinh doanh">Kinh doanh</option>
                                <option value="Marketing">Marketing</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="position" class="form-label">Chức vụ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="position" name="position" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="salary" class="form-label">Lương (VNĐ) <span
                                        class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="salary" name="salary" required>
                        </div>
                        <div class="col-md-6">
                            <label for="hireDate" class="form-label">Ngày vào làm <span
                                        class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="hireDate" name="hireDate" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bankAccount" class="form-label">Số tài khoản ngân hàng</label>
                            <input type="text" class="form-control" id="bankAccount" name="bankAccount">
                        </div>
                        <div class="col-md-6">
                            <label for="workStatus" class="form-label">Trạng thái làm việc <span
                                        class="text-danger">*</span></label>
                            <select class="form-select" id="workStatus" name="workStatus" required>
                                <option value="active">Đang làm việc</option>
                                <option value="inactive">Đã nghỉ việc</option>
                                <option value="leave">Nghỉ phép</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin đăng nhập</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label">Tên đăng nhập <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label for="password" class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveEmployee">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmployeeModalLabel">Cập nhật thông tin nhân viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm">
                    <input type="hidden" id="editEmployeeId" name="employeeId">

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin cơ bản</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editFullName" class="form-label">Họ và tên <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editFullName" name="userInfo[fullName]"
                                   required>
                        </div>
                        <div class="col-md-6">
                            <label for="editEmail" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editEmail" name="userInfo[email]" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPhoneNumber" class="form-label">Số điện thoại <span
                                        class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="editPhoneNumber" name="userInfo[phoneNumber]"
                                   required>
                        </div>
                        <div class="col-md-6">
                            <label for="editGender" class="form-label">Giới tính</label>
                            <select class="form-select" id="editGender" name="userInfo[gender]">
                                <option value="male">Nam</option>
                                <option value="female">Nữ</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editDob" class="form-label">Ngày sinh</label>
                            <input type="date" class="form-control" id="editDob" name="userInfo[dob]">
                        </div>
                        <div class="col-md-6">
                            <label for="editAddress" class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="editAddress" name="userInfo[address]">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Avatar</label>
                            <div class="input-group">
                                <select class="form-select" id="editAvatarType" name="userInfo[avatarType]">
                                    <option value="url">Nhập URL</option>
                                    <option value="file">Upload file</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="editAvatarUrlInput" class="avatar-option">
                                <label for="editAvatarUrl" class="form-label">URL Avatar</label>
                                <input type="url" class="form-control" id="editAvatarUrl" name="userInfo[avatarUrl]">
                            </div>
                            <div id="editAvatarFileInput" class="avatar-option" style="display: none;">
                                <label for="editAvatarFile" class="form-label">Upload File</label>
                                <input type="file" class="form-control" id="editAvatarFile" name="avatarFile"
                                       accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">Thông tin công việc</h5>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editDepartment" class="form-label">Phòng ban <span class="text-danger">*</span></label>
                            <select class="form-select" id="editDepartment" name="department" required>
                                <option value="">Chọn phòng ban</option>
                                <option value="Kỹ thuật">Kỹ thuật</option>
                                <option value="Nhân sự">Nhân sự</option>
                                <option value="Kế toán">Kế toán</option>
                                <option value="Kinh doanh">Kinh doanh</option>
                                <option value="Marketing">Marketing</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editPosition" class="form-label">Chức vụ <span
                                        class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editPosition" name="position" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editSalary" class="form-label">Lương (VNĐ) <span
                                        class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editSalary" name="salary" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editBankAccount" class="form-label">Số tài khoản ngân hàng</label>
                            <input type="text" class="form-control" id="editBankAccount" name="bankAccount">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editWorkStatus" class="form-label">Trạng thái làm việc <span
                                        class="text-danger">*</span></label>
                            <select class="form-select" id="editWorkStatus" name="workStatus" required>
                                <option value="active">Đang làm việc</option>
                                <option value="inactive">Đã nghỉ việc</option>
                                <option value="leave">Nghỉ phép</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="updateEmployee">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<!-- View Employee Modal -->
<div class="modal fade" id="viewEmployeeModal" tabindex="-1" aria-labelledby="viewEmployeeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEmployeeModalLabel">Thông tin chi tiết nhân viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div id="viewEmployeeAvatar" class="mx-auto mb-3"
                         style="width: 100px; height: 100px; border-radius: 50%; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user fa-3x text-secondary"></i>
                    </div>
                    <h4 id="viewEmployeeName" class="mb-1">Tên nhân viên</h4>
                    <p id="viewEmployeePosition" class="text-muted mb-0">Chức vụ</p>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Thông tin cá nhân</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted d-block">Mã nhân viên:</small>
                                    <span id="viewEmployeeId"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Email:</small>
                                    <span id="viewEmployeeEmail"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Số điện thoại:</small>
                                    <span id="viewEmployeePhone"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Giới tính:</small>
                                    <span id="viewEmployeeGender"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Ngày sinh:</small>
                                    <span id="viewEmployeeDob"></span>
                                </div>
                                <div class="mb-0">
                                    <small class="text-muted d-block">Địa chỉ:</small>
                                    <span id="viewEmployeeAddress"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-briefcase me-2"></i>Thông tin công việc</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted d-block">Phòng ban:</small>
                                    <span id="viewEmployeeDepartment"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Lương:</small>
                                    <span id="viewEmployeeSalary"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Ngày vào làm:</small>
                                    <span id="viewEmployeeHireDate"></span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Trạng thái:</small>
                                    <span id="viewEmployeeStatus"></span>
                                </div>
                                <div class="mb-0">
                                    <small class="text-muted d-block">Số tài khoản:</small>
                                    <span id="viewEmployeeBankAccount"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="viewEditEmployee">Chỉnh sửa</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteEmployeeModal" tabindex="-1" aria-labelledby="deleteEmployeeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEmployeeModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa nhân viên <strong id="deleteEmployeeName"></strong>?</p>
                <p class="text-danger">Lưu ý: Hành động này không thể hoàn tác và sẽ xóa cả tài khoản người dùng liên
                    kết.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Xác nhận xóa</button>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap and other scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        $('#avatarType').change(function () {
            if ($(this).val() === 'url') {
                $('#avatarUrlInput').show();
                $('#avatarFileInput').hide();
                $('#avatarFile').val(''); // Reset file input
            } else {
                $('#avatarUrlInput').hide();
                $('#avatarFileInput').show();
                $('#avatarUrl').val(''); // Reset URL input
            }
        });

        $('#editAvatarType').change(function () {
            if ($(this).val() === 'url') {
                $('#editAvatarUrlInput').show();
                $('#editAvatarFileInput').hide();
                $('#editAvatarFile').val('');
            } else {
                $('#editAvatarUrlInput').hide();
                $('#editAvatarFileInput').show();
                $('#editAvatarUrl').val('');
            }
        });
        // Add Employee
        $('#saveEmployee').click(function () {
            const formData = {
                username: $('#username').val(),
                fullName: $('#fullName').val(),
                gender: $('#gender').val(),
                dob: $('#dob').val(),
                address: $('#address').val(),
                email: $('#email').val(),
                phoneNumber: $('#phoneNumber').val(),
                password: $('#password').val(),
                role: 'employee',
                employeeId: $('#employeeId').val(),
                department: $('#department').val(),
                position: $('#position').val(),
                salary: parseFloat($('#salary').val()),
                hireDate: $('#hireDate').val(),
                workStatus: $('#workStatus').val(),
                bankAccount: $('#bankAccount').val(),
            };

            $.ajax({
                url: '/employees/create-employee',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if (response.success) {
                        alert('Thêm nhân viên thành công!');
                        $('#addEmployeeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Đã xảy ra lỗi';
                    alert('Lỗi: ' + errorMsg);
                }
            });
        });

        // Edit Employee - Open modal with data
        $('.edit-btn').click(function () {
            const employeeId = $(this).data('id');

            $.ajax({
                url: `/employees/find-employee/${employeeId}`, // Sửa thành find-employee
                type: 'GET',
                success: function (response) {
                    if (response.success && response.data) {
                        const employee = response.data;
                        const user = employee.userId;

                        $('#editEmployeeId').val(employee.employeeId);
                        $('#editFullName').val(user.fullName);
                        $('#editEmail').val(user.email);
                        $('#editPhoneNumber').val(user.phoneNumber);
                        $('#editGender').val(user.gender || 'male');
                        $('#editDob').val(user.dob ? new Date(user.dob).toISOString().split('T')[0] : '');
                        $('#editAddress').val(user.address || '');
                        $('#editDepartment').val(employee.department);
                        $('#editPosition').val(employee.position);
                        $('#editSalary').val(employee.salary);
                        $('#editBankAccount').val(employee.bankAccount || '');
                        $('#editWorkStatus').val(employee.workStatus);

                        $('#editEmployeeModal').modal('show');
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Không thể tải thông tin nhân viên';
                    alert('Lỗi: ' + errorMsg);
                }
            });
        });

        // Update Employee
        $('#updateEmployee').click(function () {
            const formData = {
                userInfo: {
                    fullName: $('#editFullName').val(),
                    email: $('#editEmail').val(),
                    phoneNumber: $('#editPhoneNumber').val(),
                    gender: $('#editGender').val(),
                    dob: $('#editDob').val(),
                    address: $('#editAddress').val(),
                },
                department: $('#editDepartment').val(),
                position: $('#editPosition').val(),
                salary: parseFloat($('#editSalary').val()),
                bankAccount: $('#editBankAccount').val(),
                workStatus: $('#editWorkStatus').val(),
            };

            const employeeId = $('#editEmployeeId').val();

            $.ajax({
                url: `/employees/update-employee/${employeeId}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if (response.success) {
                        alert('Cập nhật nhân viên thành công!');
                        $('#editEmployeeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Đã xảy ra lỗi';
                    alert('Lỗi: ' + errorMsg);
                }
            });
        });

        // View Employee - Open modal with data
        $('.view-btn').click(function () {
            const employeeId = $(this).data('id');

            $.ajax({
                url: `/employees/find-employee/${employeeId}`, // Sửa thành find-employee
                type: 'GET',
                success: function (response) {
                    if (response.success && response.data) {
                        const employee = response.data;
                        const user = employee.userId;

                        if (user.avatar) {
                            $('#viewEmployeeAvatar').html(`<img src="${user.avatar}" alt="Avatar" class="w-100 h-100 rounded-circle object-fit-cover">`);
                        } else {
                            $('#viewEmployeeAvatar').html('<i class="fas fa-user fa-3x text-secondary"></i>');
                        }
                        $('#viewEmployeeName').text(user.fullName);
                        $('#viewEmployeePosition').text(employee.position);
                        $('#viewEmployeeId').text(employee.employeeId);
                        $('#viewEmployeeEmail').text(user.email);
                        $('#viewEmployeePhone').text(user.phoneNumber || 'N/A');
                        $('#viewEmployeeGender').text(user.gender === 'male' ? 'Nam' : user.gender === 'female' ? 'Nữ' : 'Khác');
                        $('#viewEmployeeDob').text(user.dob ? new Date(user.dob).toLocaleDateString('vi-VN') : 'N/A');
                        $('#viewEmployeeAddress').text(user.address || 'N/A');
                        $('#viewEmployeeDepartment').text(employee.department);
                        $('#viewEmployeeSalary').text(employee.salary.toLocaleString('vi-VN') + ' VNĐ');
                        $('#viewEmployeeHireDate').text(new Date(employee.hireDate).toLocaleDateString('vi-VN'));
                        $('#viewEmployeeStatus').html(
                                employee.workStatus === 'active' ? '<span class="badge bg-success">Đang làm việc</span>' :
                                        employee.workStatus === 'inactive' ? '<span class="badge bg-danger">Đã nghỉ việc</span>' :
                                                '<span class="badge bg-warning text-dark">Nghỉ phép</span>'
                        );
                        $('#viewEmployeeBankAccount').text(employee.bankAccount || 'N/A');

                        $('#viewEmployeeModal').modal('show');
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Không thể tải thông tin nhân viên';
                    alert('Lỗi: ' + errorMsg);
                }
            });
        });

        // View Edit Button - Switch from view to edit modal
        $('#viewEditEmployee').click(function () {
            $('#viewEmployeeModal').modal('hide');
            $('.edit-btn[data-id="' + $('#viewEmployeeId').text() + '"]').click();
        });

        // Delete Employee - Open confirmation modal
        $('.delete-btn').click(function () {
            const employeeId = $(this).data('id');

            $.ajax({
                url: `/employees/find-employee/${employeeId}`,
                type: 'GET',
                success: function (response) {
                    if (response.success && response.data) {
                        $('#deleteEmployeeName').text(response.data.userId.fullName);
                        $('#confirmDelete').data('id', employeeId);
                        $('#deleteEmployeeModal').modal('show');
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Không thể tải thông tin nhân viên';
                    alert('Lỗi: ' + errorMsg);
                }
            });
        });

        $('#confirmDelete').click(function () {
            const employeeId = $(this).data('id');

            $.ajax({
                url: `/employees/delete-employee/${employeeId}`,
                type: 'DELETE',
                success: function (response) {
                    if (response.success) {
                        alert('Xóa nhân viên thành công!');
                        $('#deleteEmployeeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'Đã xảy ra lỗi';
                    alert('Lỗi: ' + errorMsg);
                }
            });
        });

        // Filter functionality
        $('#applyFilter').click(function () {
            const department = $('#departmentFilter').val();
            const status = $('#statusFilter').val();
            const search = $('#searchInput').val().toLowerCase();

            $('tbody tr').each(function () {
                const row = $(this);
                const rowDepartment = row.find('td:eq(2)').text();
                const rowStatus = row.find('td:eq(6) .badge').text().toLowerCase();
                const rowSearchText = row.text().toLowerCase();

                const departmentMatch = !department || rowDepartment === department;
                const statusMatch = !status || (status === 'active' && rowStatus.includes('đang làm việc')) ||
                        (status === 'inactive' && rowStatus.includes('đã nghỉ việc')) ||
                        (status === 'leave' && rowStatus.includes('nghỉ phép'));
                const searchMatch = !search || rowSearchText.includes(search);

                if (departmentMatch && statusMatch && searchMatch) {
                    row.show();
                } else {
                    row.hide();
                }
            });
        });
    });
</script>
